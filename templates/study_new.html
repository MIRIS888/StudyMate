{% extends "base_dashboard_new.html" %}

{% block title %}Anal√Ωza materi√°l≈Ø - StudyMate{% endblock %}
{% block page_title %}Anal√Ωza materi√°l≈Ø{% endblock %}

{% block header_actions %}
<div class="alert alert-info" style="margin: 0; padding: 0.5rem 1rem; font-size: 0.8125rem;">
    Nahrajte soubor nebo vyberte t√©ma pro AI anal√Ωzu
</div>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <!-- Upload Form -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-body">
            <form id="analysisForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- File Upload -->
                    <div>
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìÅ Nahr√°t soubor
                        </h3>
                        <div class="form-group">
                            <input type="file" id="fileInput" name="file" accept=".pdf,.docx,.txt" class="form-control">
                            <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Podporovan√© form√°ty: PDF, DOCX, TXT (max 16MB)
                            </div>
                            <p id="fileName" style="margin-top: 0.5rem; color: var(--success); font-weight: 500; font-size: 0.875rem;"></p>
                        </div>
                    </div>
                    
                    <!-- Database Selection -->
                    <div>
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìö Vybrat z datab√°ze
                        </h3>
                        <div class="form-group">
                            <label for="subject" class="form-label">P≈ôedmƒõt:</label>
                            <select id="subject" name="subject" class="form-control">
                                <option value="">-- Vyberte p≈ôedmƒõt --</option>
                                {% for subject in materials.keys() %}
                                <option value="{{ subject }}">{{ subject }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="topic" class="form-label">T√©ma:</label>
                            <select id="topic" name="topic" class="form-control">
                                <option value="">-- Nejprve vyberte p≈ôedmƒõt --</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success btn-block btn-lg" id="analyzeBtn">
                    üîç Analyzovat a vytvo≈ôit studijn√≠ materi√°ly
                </button>
            </form>
        </div>
    </div>
    
    <!-- Loading State -->
    <div class="card" id="loading" style="display: none; text-align: center;">
        <div class="card-body" style="padding: 3rem;">
            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
            <p>Zpracov√°v√°m text pomoc√≠ AI... Pros√≠m ƒçekejte.</p>
        </div>
    </div>
    
    <!-- Results -->
    <div id="results" style="display: none;">
        <!-- Summary -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìã Shrnut√≠ l√°tky
                </h3>
            </div>
            <div class="card-body">
                <ul id="summaryList" style="list-style: none; padding: 0;"></ul>
            </div>
        </div>
        
        <!-- Questions -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ‚ùì Testov√© ot√°zky
                </h3>
            </div>
            <div class="card-body">
                <div id="questionsList"></div>
            </div>
        </div>
        
        <!-- Flashcards -->
        <div class="card">
            <div class="card-header">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üÉè Kartiƒçky pro procviƒçov√°n√≠
                </h3>
            </div>
            <div class="card-body">
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">
                    Kliknƒõte na kartiƒçku pro otoƒçen√≠
                </p>
                <div id="flashcardsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;"></div>
            </div>
        </div>
    </div>
    
    <!-- Error State -->
    <div class="alert alert-error" id="error" style="display: none;"></div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .question-item {
        background-color: var(--bg-tertiary);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-light);
    }

    .question-title {
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-primary);
    }

    .question-options {
        list-style: none;
        padding: 0;
    }

    .question-option {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: white;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
    }

    .question-option:hover {
        background-color: var(--bg-hover);
    }

    .question-option.correct {
        background-color: #f0fdf4;
        border-color: var(--success);
        color: #166534;
        font-weight: 500;
    }

    .summary-item {
        padding: 1rem;
        background-color: var(--bg-tertiary);
        border-radius: var(--radius);
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--primary);
        font-size: 0.875rem;
        line-height: 1.6;
    }

    .flashcard {
        perspective: 1000px;
        height: 200px;
        cursor: pointer;
    }

    .flashcard-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        border-radius: var(--radius);
    }

    .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
    }

    .flashcard-front, .flashcard-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }

    .flashcard-front {
        background-color: var(--primary);
        color: white;
    }

    .flashcard-back {
        background-color: var(--success);
        color: white;
        transform: rotateY(180deg);
    }

    .flashcard h4, .flashcard p {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 500;
        line-height: 1.4;
    }

    @media (max-width: 768px) {
        .card-body > div:first-child {
            grid-template-columns: 1fr !important;
            gap: 1.5rem !important;
        }
        
        #flashcardsList {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Studijn√≠ materi√°ly z backendu
    const materials = {{ materials|tojson }};
    
    // DOM elementy
    const form = document.getElementById('analysisForm');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const subjectSelect = document.getElementById('subject');
    const topicSelect = document.getElementById('topic');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const error = document.getElementById('error');
    
    // Aktualizace n√°zvu souboru
    fileInput.addEventListener('change', function() {
        if (this.files[0]) {
            fileName.textContent = `‚úì Vybran√Ω soubor: ${this.files[0].name}`;
            // Vyƒçistit v√Ωbƒõr z datab√°ze
            subjectSelect.value = '';
            topicSelect.innerHTML = '<option value="">-- Nejprve vyberte p≈ôedmƒõt --</option>';
        } else {
            fileName.textContent = '';
        }
    });
    
    // Aktualizace t√©mat p≈ôi v√Ωbƒõru p≈ôedmƒõtu
    subjectSelect.addEventListener('change', function() {
        const selectedSubject = this.value;
        topicSelect.innerHTML = '';
        
        if (selectedSubject && materials[selectedSubject]) {
            topicSelect.innerHTML = '<option value="">-- Vyberte t√©ma --</option>';
            Object.keys(materials[selectedSubject]).forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            });
            
            // Vyƒçistit v√Ωbƒõr souboru
            fileInput.value = '';
            fileName.textContent = '';
        } else {
            topicSelect.innerHTML = '<option value="">-- Nejprve vyberte p≈ôedmƒõt --</option>';
        }
    });
    
    // Odesl√°n√≠ formul√°≈ôe
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validace vstupu
        const hasFile = fileInput.files[0];
        const hasSelection = subjectSelect.value && topicSelect.value;
        
        if (!hasFile && !hasSelection) {
            showError('Pros√≠m vyberte soubor nebo t√©ma z datab√°ze.');
            return;
        }
        
        // Zobrazen√≠ naƒç√≠t√°n√≠
        loading.style.display = 'block';
        results.style.display = 'none';
        error.style.display = 'none';
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Zpracov√°v√°m...';
        
        try {
            // P≈ô√≠prava dat
            const formData = new FormData();
            if (hasFile) {
                formData.append('file', fileInput.files[0]);
            } else {
                formData.append('subject', subjectSelect.value);
                formData.append('topic', topicSelect.value);
            }
            
            // API vol√°n√≠
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.error) {
                showError(data.error);
            } else {
                showResults(data);
            }
            
        } catch (err) {
            showError('Chyba p≈ôi komunikaci se serverem: ' + err.message);
        } finally {
            loading.style.display = 'none';
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'üîç Analyzovat a vytvo≈ôit studijn√≠ materi√°ly';
        }
    });
    
    function showError(message) {
        error.textContent = message;
        error.style.display = 'block';
        results.style.display = 'none';
        error.scrollIntoView({ behavior: 'smooth' });
    }
    
    function showResults(data) {
        // Shrnut√≠
        const summaryList = document.getElementById('summaryList');
        summaryList.innerHTML = '';
        data.summary.forEach(point => {
            const li = document.createElement('li');
            li.className = 'summary-item';
            li.textContent = point;
            summaryList.appendChild(li);
        });
        
        // Ot√°zky
        const questionsList = document.getElementById('questionsList');
        questionsList.innerHTML = '';
        data.questions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            
            const questionTitle = document.createElement('h4');
            questionTitle.className = 'question-title';
            questionTitle.textContent = `${index + 1}. ${q.question}`;
            questionDiv.appendChild(questionTitle);
            
            const optionsList = document.createElement('ul');
            optionsList.className = 'question-options';
            
            q.options.forEach(option => {
                const li = document.createElement('li');
                li.className = 'question-option';
                li.textContent = option;
                if (option.startsWith(q.correct)) {
                    li.classList.add('correct');
                }
                optionsList.appendChild(li);
            });
            
            questionDiv.appendChild(optionsList);
            questionsList.appendChild(questionDiv);
        });
        
        // Kartiƒçky
        const flashcardsList = document.getElementById('flashcardsList');
        flashcardsList.innerHTML = '';
        data.flashcards.forEach((card, index) => {
            const flashcardDiv = document.createElement('div');
            flashcardDiv.className = 'flashcard';
            flashcardDiv.innerHTML = `
                <div class="flashcard-inner">
                    <div class="flashcard-front">
                        <h4>${card.question}</h4>
                    </div>
                    <div class="flashcard-back">
                        <p>${card.answer}</p>
                    </div>
                </div>
            `;
            
            // Flip efekt
            flashcardDiv.addEventListener('click', function() {
                this.classList.toggle('flipped');
            });
            
            flashcardsList.appendChild(flashcardDiv);
        });
        
        results.style.display = 'block';
        error.style.display = 'none';
        results.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}